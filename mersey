#!/usr/bin/env php
<?php

if (file_exists(__DIR__ . '/vendor/autoload.php')) {
    require __DIR__ . '/vendor/autoload.php';
} else {
    require __DIR__ . '/../../autoload.php';
}

$envFile = __DIR__ . '/.env';

if (file_exists($envFile)) {
    $dotEnv = new Dotenv\Dotenv(__DIR__);
    $dotEnv->load();
}

$appEnv = env('APP_ENV', 'production');

use Weeks\Mersey\Console;
use Weeks\Mersey\Exceptions\MerseyAppException;
use Weeks\Mersey\Factories\ProjectFactory;
use Weeks\Mersey\Factories\ServerFactory;
use Weeks\Mersey\Mersey as MerseyApp;
use Weeks\Mersey\Services\JsonValidator;

$homeDir = env('HOME');

$schema = getSchema($homeDir, $appEnv);

$servers = getServerConfig($homeDir, $appEnv);

putenv('MERSEY_SERVER_CONFIG=' . $servers);

$app = new MerseyApp(
    new Console('Mersey', '1.1.1'),
    new JsonValidator($schema),
    new ServerFactory(),
    new ProjectFactory()
);

try {

    $app->loadServersFromJson($servers);
    $app->run();

} catch (MerseyAppException $e) {

    $app->renderException($e);
    die();

}

