#!/usr/bin/env php
<?php

if (file_exists(__DIR__ . '/vendor/autoload.php')) {
    require __DIR__ . '/vendor/autoload.php';
} else {
    require __DIR__ . '/../../autoload.php';
}

use Weeks\Mersey\Console;
use Weeks\Mersey\Exceptions\MerseyAppException;
use Weeks\Mersey\Factories\ProjectFactory;
use Weeks\Mersey\Factories\ServerFactory;
use Weeks\Mersey\Mersey as MerseyApp;
use Weeks\Mersey\Services\JsonValidator;

$homeDir = getenv('HOME');

// check for global installation
$globalSchema = $homeDir . '/.composer/vendor/dannyweeks/mersey/schema.json';
if (file_exists($globalSchema)) {
    $schema = $globalSchema;
} else {
    $schema = 'schema.json';
}

// check for ~/.mersey servers before trying to use a local servers.json

$globalServers = $homeDir . '/.mersey/servers.json';

if (file_exists($globalServers)) {
    $servers = $globalServers;
} else {
    $servers = 'servers.json';
}

putenv('MERSEY_SERVER_CONFIG=' . $servers);

$app = new MerseyApp(
    new Console('Mersey', '1.1.1'),
    new JsonValidator($schema),
    new ServerFactory(),
    new ProjectFactory()
);

try {

    $app->loadServersFromJson($servers);
    $app->run();

} catch (MerseyAppException $e) {

    $app->renderException($e);
    die();

}

